# Development Dockerfile - Vite serves on 8000, proxies API to internal backend
FROM node:20-alpine AS frontend

WORKDIR /frontend
COPY manager/frontend/package.json manager/frontend/package-lock.json ./
RUN npm ci
COPY manager/frontend ./


FROM python:3.11-slim

WORKDIR /app

# Install system dependencies + Node.js for running Vite
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    curl \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Copy Python requirements and install
COPY manager/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY manager/src ./src
COPY shared ./shared

# Copy frontend with node_modules from builder
COPY --from=frontend /frontend ./frontend

# Create audio storage directory
RUN mkdir -p /app/audio

# Install a process manager to run both services
RUN pip install supervisor

# Create dev vite config that proxies to internal backend
RUN echo 'import { defineConfig } from "vite"\n\
import react from "@vitejs/plugin-react"\n\
import tailwindcss from "@tailwindcss/vite"\n\
import path from "path"\n\
\n\
export default defineConfig({\n\
  plugins: [react(), tailwindcss()],\n\
  resolve: {\n\
    alias: {\n\
      "@": path.resolve(__dirname, "./src"),\n\
    },\n\
  },\n\
  server: {\n\
    host: "0.0.0.0",\n\
    port: 8000,\n\
    proxy: {\n\
      "/api": {\n\
        target: "http://127.0.0.1:8001",\n\
        changeOrigin: true,\n\
        rewrite: (path) => path.replace(/^\\/api/, ""),\n\
      },\n\
      "/feeds": { target: "http://127.0.0.1:8001" },\n\
      "/feed": { target: "http://127.0.0.1:8001" },\n\
      "/episodes": { target: "http://127.0.0.1:8001" },\n\
      "/upload": { target: "http://127.0.0.1:8001" },\n\
      "/progress": { target: "http://127.0.0.1:8001" },\n\
      "/files": { target: "http://127.0.0.1:8001" },\n\
      "/health": { target: "http://127.0.0.1:8001" },\n\
      "/ws": {\n\
        target: "ws://127.0.0.1:8001",\n\
        ws: true,\n\
      },\n\
    },\n\
  },\n\
})\n\
' > /app/frontend/vite.config.dev.ts

# Create supervisor config - backend on 8001, vite on 8000
RUN echo '[supervisord]\n\
nodaemon=true\n\
logfile=/dev/stdout\n\
logfile_maxbytes=0\n\
\n\
[program:backend]\n\
command=uvicorn src.main:app --host 127.0.0.1 --port 8001 --reload\n\
directory=/app\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
\n\
[program:frontend]\n\
command=npm run dev -- --config vite.config.dev.ts\n\
directory=/app/frontend\n\
stdout_logfile=/dev/stdout\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/stderr\n\
stderr_logfile_maxbytes=0\n\
' > /etc/supervisord.conf

EXPOSE 8000

CMD ["supervisord", "-c", "/etc/supervisord.conf"]
